unit About;

interface

uses
  Winapi.Windows, Winapi.ShellAPI,
  System.SysUtils, System.Classes, System.Types, System.UITypes, System.DateUtils,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.StdCtrls, Vcl.ExtCtrls;

type
  TFrmAbout = class(TForm)
    PanelTop: TPanel;
    ImageIcon: TImage;
    LblAppName: TLabel;
    LblVersion: TLabel;
    LblBuild: TLabel;
    LblAuthor: TLabel;
    LblLink: TLabel;
    PanelBottom: TPanel;
    BtnOK: TButton;
    BtnCopy: TButton;
  private
    class function GetFileVersion: string; static;
    class function GetBuildDate: string; static;
    procedure LinkClick(Sender: TObject);
    procedure CopyClick(Sender: TObject);
  public
    class procedure Execute(const Author, LinkURL: string); // zeigt das Fenster modal
  end;

implementation

{$R *.dfm}

{ Hilfsfunktionen }

class function TFrmAbout.GetFileVersion: string;
var
  Size, Handle: DWORD;
  Buffer: TBytes;
  FixedFileInfo: PVSFixedFileInfo;
  Len: UINT;
  Mj, Mn, Rel, Bld: Word;
begin
  Result := '0.0.0.0';
  Size := GetFileVersionInfoSize(PChar(ParamStr(0)), Handle);
  if Size = 0 then Exit;
  SetLength(Buffer, Size);
  if not GetFileVersionInfo(PChar(ParamStr(0)), Handle, Size, Buffer) then Exit;
  if VerQueryValue(Buffer, '\', Pointer(FixedFileInfo), Len) and (Len >= SizeOf(TVSFixedFileInfo)) then
  begin
    Mj  := HiWord(FixedFileInfo.dwFileVersionMS);
    Mn  := LoWord(FixedFileInfo.dwFileVersionMS);
    Rel := HiWord(FixedFileInfo.dwFileVersionLS);
    Bld := LoWord(FixedFileInfo.dwFileVersionLS);
    Result := Format('%d.%d.%d.%d', [Mj, Mn, Rel, Bld]);
  end;
end;

class function TFrmAbout.GetBuildDate: string;
var
  FT: TDateTime;
begin
  // DateTime des Executables (letzte Änderung) als Build-Zeit
  if FileAge(ParamStr(0), FT) then
    Result := FormatDateTime('dd.mm.yyyy, hh:nn', FT)
  else
    Result := '-';
end;

{ UI-Aktionen }

procedure TFrmAbout.LinkClick(Sender: TObject);
begin
  ShellExecute(0, 'open', PChar(LblLink.Hint), nil, nil, SW_SHOWNORMAL);
end;

procedure TFrmAbout.CopyClick(Sender: TObject);
var
  S: string;
begin
  S :=
    LblAppName.Caption + sLineBreak +
    LblVersion.Caption + sLineBreak +
    LblBuild.Caption   + sLineBreak +
    LblAuthor.Caption  + sLineBreak +
    'Link: ' + LblLink.Hint;

  Clipboard.AsText := S;
  MessageDlg('Infos in die Zwischenablage kopiert.', mtInformation, [mbOK], 0);
end;

{ Öffnen }

class procedure TFrmAbout.Execute(const Author, LinkURL: string);
var
  F: TFrmAbout;
begin
  F := TFrmAbout.Create(nil);
  try
    // Fenster-Styles
    F.BorderStyle := bsDialog;
    F.Position := poScreenCenter;
    F.Caption := 'Über';

    // Panels
    F.PanelTop.Align := alTop;
    F.PanelTop.Height := 80;
    F.PanelBottom.Align := alBottom;
    F.PanelBottom.Height := 48;

    // Icon
    F.ImageIcon.Align := alLeft;
    F.ImageIcon.Width := 64;
    F.ImageIcon.Picture.Icon := Application.Icon;

    // Labels
    F.LblAppName.Left := 80;  F.LblAppName.Top := 8;
    F.LblVersion.Left := 80;  F.LblVersion.Top := 30;
    F.LblBuild.Left   := 80;  F.LblBuild.Top   := 48;
    F.LblAuthor.Left  := 80;  F.LblAuthor.Top  := 66;

    F.LblAppName.Caption := Application.Title;
    if F.LblAppName.Caption = '' then
      F.LblAppName.Caption := ChangeFileExt(ExtractFileName(ParamStr(0)), '');

    F.LblAppName.Font.Style := [fsBold];
    F.LblAppName.Font.Size := 11;

    F.LblVersion.Caption := 'Version: ' + GetFileVersion;
    F.LblBuild.Caption   := 'Build:   ' + GetBuildDate;
    F.LblAuthor.Caption  := 'Autor:   ' + Author;

    // Link
    F.LblLink.Parent := F.PanelTop;
    F.LblLink.Left := 80; F.LblLink.Top := 86; // falls PanelTop höher ist
    F.LblLink.Font.Color := clBlue;
    F.LblLink.Font.Style := [fsUnderline];
    F.LblLink.Cursor := crHandPoint;
    F.LblLink.Caption := 'Projektseite';
    F.LblLink.Hint := LinkURL;
    F.LblLink.ShowHint := True;
    F.LblLink.OnClick := F.LinkClick;

    // Buttons
    F.BtnOK.Parent := F.PanelBottom;
    F.BtnCopy.Parent := F.PanelBottom;
    F.BtnOK.Caption := 'OK';
    F.BtnCopy.Caption := 'Kopieren';
    F.BtnOK.Anchors := [akRight, akBottom];
    F.BtnCopy.Anchors := [akRight, akBottom];
    F.ClientWidth := 460;
    F.ClientHeight := 160;

    F.BtnOK.Left := F.ClientWidth - 90;
    F.BtnOK.Top  := F.ClientHeight - F.PanelBottom.Height + 10;
    F.BtnCopy.Left := F.BtnOK.Left - 100;
    F.BtnCopy.Top  := F.BtnOK.Top;

    F.BtnOK.ModalResult := mrOK;
    F.BtnCopy.OnClick := F.CopyClick;

    F.ShowModal;
  finally
    F.Free;
  end;
end;

end.

